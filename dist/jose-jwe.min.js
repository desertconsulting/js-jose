!function(a,b,c,d,e,f){"use strict";var g={},h={},i={};g.caniuse=function(){var a=!0;return a=a&&"function"==typeof c,a=a&&"function"==typeof c.reject,a=a&&"function"==typeof c.prototype.then,a=a&&"function"==typeof c.all,a=a&&"object"==typeof b,a=a&&"object"==typeof b.subtle,a=a&&"function"==typeof b.getRandomValues,a=a&&"function"==typeof b.subtle.importKey,a=a&&"function"==typeof b.subtle.generateKey,a=a&&"function"==typeof b.subtle.exportKey,a=a&&"function"==typeof b.subtle.wrapKey,a=a&&"function"==typeof b.subtle.unwrapKey,a=a&&"function"==typeof b.subtle.encrypt,a=a&&"function"==typeof b.subtle.decrypt,a=a&&"function"==typeof b.subtle.sign,a=a&&"function"==typeof ArrayBuffer,a=a&&("function"==typeof e||"object"==typeof e),a=a&&("function"==typeof Uint32Array||"object"==typeof Uint32Array),a=a&&"object"==typeof JSON,a=a&&"function"==typeof JSON.parse,a=a&&"function"==typeof JSON.stringify,a=a&&"function"==typeof atob,a=a&&"function"==typeof btoa},g.assert=function(a,b){if(!a)throw new d(b)},a.Jose=g,a.JoseJWE=h,a.JoseJWS=i,g.WebCryptographer=function(){var a=this;a.setKeyEncryptionAlgorithm("RSA-OAEP"),a.setContentEncryptionAlgorithm("A256GCM"),a.setContentSignAlgorithm("RS256")},g.WebCryptographer.prototype.setKeyEncryptionAlgorithm=function(a){this.key_encryption=l(a)},g.WebCryptographer.prototype.getKeyEncryptionAlgorithm=function(){return this.key_encryption.jwe_name},g.WebCryptographer.prototype.setContentEncryptionAlgorithm=function(a){this.content_encryption=l(a)},g.WebCryptographer.prototype.getContentEncryptionAlgorithm=function(){return this.content_encryption.jwe_name},g.WebCryptographer.prototype.setContentSignAlgorithm=function(a){this.content_sign=n(a)},g.WebCryptographer.prototype.getContentSignAlgorithm=function(){return this.content_sign.jwa_name},g.WebCryptographer.prototype.createIV=function(){var a=new e(new Array(this.content_encryption.iv_bytes));return b.getRandomValues(a)},g.WebCryptographer.prototype.createCek=function(){var a=j(this.content_encryption);return b.subtle.generateKey(a.id,!0,a.enc_op)},g.WebCryptographer.prototype.wrapCek=function(a,c){return b.subtle.wrapKey("raw",a,c,this.key_encryption.id)},g.WebCryptographer.prototype.unwrapCek=function(a,c){var d=this,e=j(d.content_encryption),f=d.content_encryption.specific_cek_bytes>0,g=d.key_encryption.id;return b.subtle.unwrapKey("raw",a,c,g,e.id,f,e.dec_op)};var j=function(a){var b=a.specific_cek_bytes;if(b){if(16==b)return{id:{name:"AES-CBC",length:128},enc_op:["encrypt"],dec_op:["decrypt"]};if(32==b)return{id:{name:"AES-CBC",length:256},enc_op:["encrypt"],dec_op:["decrypt"]};if(64==b)return{id:{name:"HMAC",hash:{name:"SHA-256"}},enc_op:["sign"],dec_op:["verify"]};if(128==b)return{id:{name:"HMAC",hash:{name:"SHA-384"}},enc_op:["sign"],dec_op:["verify"]};g.assert(!1,"getCekWorkaround: invalid len")}return{id:a.id,enc_op:["encrypt"],dec_op:["decrypt"]}};g.WebCryptographer.prototype.encrypt=function(a,e,f,g){var h=this.content_encryption;if(a.length!=h.iv_bytes)return c.reject(d("invalid IV length"));if(h.auth.aead){var i=h.auth.tag_bytes,j={name:h.id.name,iv:a,additionalData:e,tagLength:8*i};return f.then(function(a){return b.subtle.encrypt(j,a,g).then(function(a){var b=a.byteLength-i;return{cipher:a.slice(0,b),tag:a.slice(b)}})})}var l=k(h,f,["encrypt"]),n=l[0],o=l[1],p=o.then(function(c){var d={name:h.id.name,iv:a};return b.subtle.encrypt(d,c,g)}),q=p.then(function(b){return m(h,n,e,a,b)});return c.all([p,q]).then(function(a){var b=a[0],c=a[1];return{cipher:b,tag:c}})},g.WebCryptographer.prototype.decrypt=function(a,f,h,i,j){var l=function(a,f,h,i){return g.assert(h instanceof e,"compare: invalid input"),g.assert(i instanceof e,"compare: invalid input"),f.then(function(f){var g=b.subtle.sign(a.auth.id,f,h),j=b.subtle.sign(a.auth.id,f,i);return c.all([g,j]).then(function(a){var b=new e(a[0]),f=new e(a[1]);if(b.length!=f.length)throw new d("compare failed");for(var g=0;g<b.length;g++)if(b[g]!=f[g])throw new d("compare failed");return c.accept(null)})})};if(h.length!=this.content_encryption.iv_bytes)return c.reject(d("decryptCiphertext: invalid IV"));var n=this.content_encryption;if(n.auth.aead){var o={name:n.id.name,iv:h,additionalData:f,tagLength:8*n.auth.tag_bytes};return a.then(function(a){var c=p.arrayBufferConcat(i,j);return b.subtle.decrypt(o,a,c)})}var q=k(n,a,["decrypt"]),r=q[0],s=q[1],t=m(n,r,f,h,i);return c.all([s,t]).then(function(a){var f=a[0],g=a[1];return l(n,r,new e(g),j).then(function(){var a={name:n.id.name,iv:h};return b.subtle.decrypt(a,f,i)})["catch"](function(){return c.reject(d("decryptCiphertext: MAC failed."))})})},g.WebCryptographer.prototype.sign=function(a,c,d){var e=this.content_sign;return a.alg&&(e=n(a.alg)),d.then(function(d){return b.subtle.sign(e.id,d,p.arrayFromString(p.Base64Url.encode(JSON.stringify(a))+"."+p.Base64Url.encodeArray(c)))})["catch"](function(a){console.log(a)})},g.WebCryptographer.prototype.verify=function(a,c,d,e){var f=this.content_sign;return e.then(function(e){return b.subtle.verify(f.id,e,d,p.arrayFromString(a+"."+c))})},g.WebCryptographer.keyId=function(a){return p.crc32(a.n+"+"+a.d)};var k=function(a,e,f){var g=e.then(function(a){return b.subtle.exportKey("raw",a)}),h=g.then(function(e){if(8*e.byteLength!=a.id.length+8*a.auth.key_bytes)return c.reject(d("encryptPlainText: incorrect cek length"));var f=e.slice(0,a.auth.key_bytes);return b.subtle.importKey("raw",f,a.auth.id,!1,["sign"])}),i=g.then(function(e){if(8*e.byteLength!=a.id.length+8*a.auth.key_bytes)return c.reject(d("encryptPlainText: incorrect cek length"));var g=e.slice(a.auth.key_bytes);return b.subtle.importKey("raw",g,a.id,!1,f)});return[h,i]},l=function(a){switch(a){case"RSA-OAEP":return{jwe_name:"RSA-OAEP",id:{name:"RSA-OAEP",hash:{name:"SHA-1"}}};case"RSA-OAEP-256":return{jwe_name:"RSA-OAEP-256",id:{name:"RSA-OAEP",hash:{name:"SHA-256"}}};case"A128KW":return{jwe_name:"A128KW",id:{name:"AES-KW",length:128}};case"A256KW":return{jwe_name:"A256KW",id:{name:"AES-KW",length:256}};case"A128CBC-HS256":return{jwe_name:"A128CBC-HS256",id:{name:"AES-CBC",length:128},iv_bytes:16,specific_cek_bytes:32,auth:{key_bytes:16,id:{name:"HMAC",hash:{name:"SHA-256"}},truncated_bytes:16}};case"A256CBC-HS512":return{jwe_name:"A256CBC-HS512",id:{name:"AES-CBC",length:256},iv_bytes:16,specific_cek_bytes:64,auth:{key_bytes:32,id:{name:"HMAC",hash:{name:"SHA-512"}},truncated_bytes:32}};case"A128GCM":return{jwe_name:"A128GCM",id:{name:"AES-GCM",length:128},iv_bytes:12,auth:{aead:!0,tag_bytes:16}};case"A256GCM":return{jwe_name:"A256GCM",id:{name:"AES-GCM",length:256},iv_bytes:12,auth:{aead:!0,tag_bytes:16}};default:throw d("unsupported algorithm: "+a)}},m=function(a,c,d,f,g){return c.then(function(c){var h=new e(p.arrayFromInt32(8*d.length)),i=new e(8);i.set(h,4);var j=p.arrayBufferConcat(d,f,g,i);return b.subtle.sign(a.auth.id,c,j).then(function(b){return b.slice(0,a.auth.truncated_bytes)})})},n=function(a){switch(a){case"RS256":return{jwa_name:"RS256",id:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}}};case"RS384":return{jwa_name:"RS384",id:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}}};case"RS512":return{jwa_name:"RS512",id:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}}};case"HS256":return{jwa_name:"HS256",id:{name:"HMAC",hash:{name:"SHA-256"}}};case"HS384":return{jwa_name:"HS384",id:{name:"HMAC",hash:{name:"SHA-384"}}};case"HS512":return{jwa_name:"HS512",id:{name:"HMAC",hash:{name:"SHA-512"}}};case"ES256":return{jwa_name:"ES256",id:{name:"ECDSA",hash:{name:"SHA-256"}}};case"ES384":return{jwa_name:"ES384",id:{name:"ECDSA",hash:{name:"SHA-384"}}};case"ES512":return{jwa_name:"ES512",id:{name:"ECDSA",hash:{name:"SHA-512"}}};default:throw d("unsupported algorithm: "+a)}},o=function(a){switch(a){case"RS256":case"RS384":case"RS512":case"HS256":case"HS384":case"HS512":case"ES256":case"ES384":case"ES512":return{publicKey:"verify",privateKey:"sign"};case"RSA-OAEP":case"RSA-OAEP-256":case"A128KW":case"A256KW":return{publicKey:"wrapKey",privateKey:"unwrapKey"};default:throw d("unsupported algorithm: "+a)}};g.Utils={};var p={};g.Utils.importRsaPublicKey=function(a,c){var d,e,f,g=null;if(c=c||a.alg||"RSA-OAEP",f=o(c),"wrapKey"==f.publicKey)d=p.convertRsaKey(a,["n","e"]),g=l(c);else{e={};for(var h in a)a.hasOwnProperty(h)&&(e[h]=a[h]);!e.alg&&c&&(e.alg=c),g=n(e.alg),d=p.convertRsaKey(e,["n","e"]),d.ext=!0}return b.subtle.importKey("jwk",d,g.id,!1,[f.publicKey])},g.Utils.importRsaPrivateKey=function(a,c){var d,e,f,g;if(c=c||a.alg||"RSA-OAEP",g=o(c),"unwrapKey"==g.privateKey)d=p.convertRsaKey(a,["n","e","d","p","q","dp","dq","qi"]),e=l("RSA-OAEP");else{f={};for(var h in a)a.hasOwnProperty(h)&&(f[h]=a[h]);e=n(c),!f.alg&&c&&(f.alg=c),d=p.convertRsaKey(f,["n","e","d","p","q","dp","dq","qi"]),d.ext=!0}return b.subtle.importKey("jwk",d,e.id,!1,[g.privateKey])},p.isString=function(a){return"string"==typeof a||a instanceof String},p.arrayish=function(a){return a instanceof Array?a:a instanceof e?a:a instanceof ArrayBuffer?new e(a):void g.assert(!1,"arrayish: invalid input")},p.convertRsaKey=function(a,b){var c={},d=[];b.map(function(b){a[b]===f&&d.push(b)}),d.length>0&&g.assert(!1,"convertRsaKey: Was expecting "+d.join()),a.kty!==f&&g.assert("RSA"==a.kty,"convertRsaKey: expecting rsa_key['kty'] to be 'RSA'"),c.kty="RSA",a.alg!==f?c.alg=a.alg:c.alg="RSA-OAEP";for(var e=function(a){return parseInt(a,16)},h=0;h<b.length;h++){var i=b[h],j=a[i];if("e"==i)"number"==typeof j&&(j=p.Base64Url.encodeArray(p.stripLeadingZeros(p.arrayFromInt32(j))));else if(/^([0-9a-fA-F]{2}:)+[0-9a-fA-F]{2}$/.test(j)){var k=j.split(":").map(e);j=p.Base64Url.encodeArray(p.stripLeadingZeros(k))}else"string"!=typeof j&&g.assert(!1,"convertRsaKey: expecting rsa_key['"+i+"'] to be a string");c[i]=j}return c},p.arrayFromString=function(a){g.assert(p.isString(a),"arrayFromString: invalid input");var b=a.split("").map(function(a){return a.charCodeAt(0)});return new e(b)},p.stringFromArray=function(a){g.assert(a instanceof ArrayBuffer,"stringFromArray: invalid input"),a=new e(a);for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a[c]);return b},p.stripLeadingZeros=function(a){a instanceof ArrayBuffer&&(a=new e(a));for(var b=!0,c=[],d=0;d<a.length;d++)b&&0===a[d]||(b=!1,c.push(a[d]));return c},p.arrayFromInt32=function(a){g.assert("number"==typeof a,"arrayFromInt32: invalid input"),g.assert(a==a|0,"arrayFromInt32: out of range");for(var b=new e(new Uint32Array([a]).buffer),c=new e(4),d=0;4>d;d++)c[d]=b[3-d];return c.buffer},p.arrayBufferConcat=function(){for(var a=[],b=0,c=0;c<arguments.length;c++)a.push(p.arrayish(arguments[c])),b+=a[c].length;var d=new e(b),f=0;for(c=0;c<arguments.length;c++)for(var h=0;h<a[c].length;h++)d[f++]=a[c][h];return g.assert(f==b,"arrayBufferConcat: unexpected offset"),d},p.Base64Url={},p.Base64Url.encode=function(a){return g.assert(p.isString(a),"Base64Url.encode: invalid input"),btoa(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")},p.Base64Url.encodeArray=function(a){a=p.arrayish(a);for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a[c]);return p.Base64Url.encode(b)},p.Base64Url.decode=function(a){return g.assert(p.isString(a),"Base64Url.decode: invalid input"),atob(a.replace(/-/g,"+").replace(/_/g,"/"))},p.Base64Url.decodeArray=function(a){return g.assert(p.isString(a),"Base64Url.decodeArray: invalid input"),p.arrayFromString(p.Base64Url.decode(a))},p.crc32=function(){for(var a=new Uint32Array(256),b=256;b--;){for(var c=b,d=8;d--;)c=1&c?3988292384^c>>>1:c>>>1;a[b]=c}return function(b){for(var c=-1,d=0,e=b.length;e>d;d++)c=c>>>8^a[255&c^b[d]];return(-1^c)>>>0}}(),h.Encrypter=function(a,b){this.cryptographer=a,this.key_promise=b,this.userHeaders={}},h.Encrypter.prototype.addHeader=function(a,b){this.userHeaders[a]=b},h.Encrypter.prototype.encrypt=function(a){var b=function(a,b){var c={};for(var d in this.userHeaders)c[d]=this.userHeaders[d];c.alg=this.cryptographer.getKeyEncryptionAlgorithm(),c.enc=this.cryptographer.getContentEncryptionAlgorithm();var e=p.Base64Url.encode(JSON.stringify(c)),f=this.cryptographer.createIV(),g=p.arrayFromString(e);return b=p.arrayFromString(b),this.cryptographer.encrypt(f,g,a,b).then(function(a){return a.header=e,a.iv=f,a})},d=this.cryptographer.createCek(),e=c.all([this.key_promise,d]).then(function(a){var b=a[0],c=a[1];return this.cryptographer.wrapCek(c,b)}.bind(this)),f=b.bind(this,d,a)();return c.all([e,f]).then(function(a){var b=a[0],c=a[1];return c.header+"."+p.Base64Url.encodeArray(b)+"."+p.Base64Url.encodeArray(c.iv)+"."+p.Base64Url.encodeArray(c.cipher)+"."+p.Base64Url.encodeArray(c.tag)})},h.Decrypter=function(a,b){this.cryptographer=a,this.key_promise=b,this.headers={}},h.Decrypter.prototype.getHeaders=function(){return this.headers},h.Decrypter.prototype.decrypt=function(a){var b=a.split(".");if(5!=b.length)return c.reject(d("decrypt: invalid input"));if(this.headers=JSON.parse(p.Base64Url.decode(b[0])),!this.headers.alg)return c.reject(d("decrypt: missing alg"));if(!this.headers.enc)return c.reject(d("decrypt: missing enc"));if(this.cryptographer.setKeyEncryptionAlgorithm(this.headers.alg),this.cryptographer.setContentEncryptionAlgorithm(this.headers.enc),this.headers.crit)return c.reject(d("decrypt: crit is not supported"));var e=p.Base64Url.decodeArray(b[1]),f=this.key_promise.then(function(a){return this.cryptographer.unwrapCek(e,a)}.bind(this)),g=this.cryptographer.decrypt(f,p.arrayFromString(b[0]),p.Base64Url.decodeArray(b[2]),p.Base64Url.decodeArray(b[3]),p.Base64Url.decodeArray(b[4]));return g.then(p.stringFromArray)},i.Signer=function(a,b){this.cryptographer=a,this.rsa_key=b,this.key_promise=g.Utils.importRsaPrivateKey(b,a.getContentSignAlgorithm(),"sign"),this.headers={}},i.Signer.prototype.getHeaders=function(){return this.headers},i.Signer.prototype.sign=function(a,b,c){var d=this,e=g.WebCryptographer.keyId(d.rsa_key);if(b||(b={}),b.alg||(b.alg=cryptographer.getContentSignAlgorithm(),b.typ="JWT"),b.kid||(b.kid=e),c.kid||(c.kid=e),p.isString(a))a=p.arrayFromString(a);else try{a=p.arrayish(a)}catch(f){a instanceof Object&&(a=p.arrayFromString(JSON.stringify(a)))}return this.cryptographer.sign(b,a,this.key_promise).then(function(d){return new q(b,c,a,d)})};var q=function(a,b,c,d){var e=this;e.header=b,e.payload=p.Base64Url.encodeArray(c),e.signature=p.Base64Url.encodeArray(d),e.signatures=[{kid:b.kid,signature:e.signature}],e["protected"]=p.Base64Url.encode(JSON.stringify(a))};q.prototype.JsonSerialize=function(){return JSON.stringify(this)},q.prototype.CompactSerialize=function(){var a=this;return a["protected"]+"."+a.payload+"."+a.signature},i.Verifier=function(a,b,c,e){var f,h,i,j,k,l,m,n=this,o=/^([a-z_\\-])\\.([a-z_\\-])\\.([a-z_\\-])$/i;if(n.cryptographer=a,f=a.getContentSignAlgorithm(),n.cryptographer=new g.WebCryptographer,p.isString(b)){if(h=o.exec(b)){if(4!=h.length)throw new d("wrong JWS compact serialization format");b={"protected":h[1],payload:h[2],signature:h[3]}}}else if("object"!=typeof b)throw new d("data format not supported");i=b["protected"],j=b.header,k=b.payload,l=b.signatures||[],n.aad=i,m=p.Base64Url.decode(i);try{m=JSON.parse(m)}catch(q){}if(!m&&!j)throw new d("at least one header is required");if(!m.alg)throw new d("'alg' is a mandatory header");if(m.alg!=f)throw new d("the alg header '"+m.alg+"' doesn't match the requested algorithm '"+f+"'");if(m&&m.typ&&"JWT"!=m.typ)throw new d("typ '"+m.typ+"' not supported");b.signature&&l.unshift({kid:m.kid,signature:b.signature}),n.signatures={};for(var r=0;r<l.length;r++)n.signatures[l[r].kid]=p.arrayFromString(p.Base64Url.decode(l[r].signature));n.payload=k,c&&(e?console.warn("it's not safe to not pass a key_id"):e=g.WebCryptographer.keyId(c),n.key_promises={},n.key_promises[e]=g.Utils.importRsaPublicKey(c,f,"verify"))},i.Verifier.prototype.addRecipient=function(a,b){var c=this,d=g.Utils.importRsaPublicKey(a,alg,"verify");b?console.warn("it's not safe to not pass a key_id"):b=g.WebCryptographer.keyId(a),c.recipients instanceof Object||(c.key_promises={}),c.key_promises[b]=d},i.Verifier.prototype.verify=function(){var a=this,b=[];if(a.key_promises instanceof Object){for(var e in a.key_promises){var f;a.key_promises.hasOwnProperty(e)&&b.push(a.cryptographer.verify(a.aad,a.payload,a.signatures[e],a.key_promises[e],e).then(function(a){return{kid:f,verified:a}}))}return c.all(b)}throw new d("at least a recipient is needed to verify the JWS signature")},h.Utils=g.Utils,h.WebCryptographer=g.WebCryptographer}(window,window.crypto,window.Promise,window.Error,window.Uint8Array);