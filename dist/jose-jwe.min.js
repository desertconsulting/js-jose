!function(){Jose={},JoseJWE={},JoseJWS={},Jose.caniuse=function(){var a=!0;return a=a&&"function"==typeof Promise,a=a&&"function"==typeof Promise.reject,a=a&&"function"==typeof Promise.prototype.then,a=a&&"function"==typeof Promise.all,a=a&&"object"==typeof crypto,a=a&&"object"==typeof crypto.subtle,a=a&&"function"==typeof crypto.getRandomValues,a=a&&"function"==typeof crypto.subtle.importKey,a=a&&"function"==typeof crypto.subtle.generateKey,a=a&&"function"==typeof crypto.subtle.exportKey,a=a&&"function"==typeof crypto.subtle.wrapKey,a=a&&"function"==typeof crypto.subtle.unwrapKey,a=a&&"function"==typeof crypto.subtle.encrypt,a=a&&"function"==typeof crypto.subtle.decrypt,a=a&&"function"==typeof crypto.subtle.sign,a=a&&"function"==typeof ArrayBuffer,a=a&&("function"==typeof Uint8Array||"object"==typeof Uint8Array),a=a&&("function"==typeof Uint32Array||"object"==typeof Uint32Array),a=a&&"object"==typeof JSON,a=a&&"function"==typeof JSON.parse,a=a&&"function"==typeof JSON.stringify,a=a&&"function"==typeof atob,a=a&&"function"==typeof btoa},Jose.assert=function(a,b){if(!a)throw new Error(b)},Jose.WebCryptographer=function(){this.setKeyEncryptionAlgorithm("RSA-OAEP"),this.setContentEncryptionAlgorithm("A256GCM"),this.setContentSignAlgorithm("RS256")},Jose.WebCryptographer.prototype.setKeyEncryptionAlgorithm=function(a){this.key_encryption=c(a)},Jose.WebCryptographer.prototype.getKeyEncryptionAlgorithm=function(){return this.key_encryption.jwe_name},Jose.WebCryptographer.prototype.setContentEncryptionAlgorithm=function(a){this.content_encryption=c(a)},Jose.WebCryptographer.prototype.getContentEncryptionAlgorithm=function(){return this.content_encryption.jwe_name},Jose.WebCryptographer.prototype.setContentSignAlgorithm=function(a){this.content_sign=e(a)},Jose.WebCryptographer.prototype.getContentSignAlgorithm=function(){return this.content_sign.jwa_name},Jose.WebCryptographer.prototype.createIV=function(){var a=new Uint8Array(new Array(this.content_encryption.iv_bytes)),b=crypto.getRandomValues(a);return b},Jose.WebCryptographer.prototype.createCek=function(){var b=a(this.content_encryption);return crypto.subtle.generateKey(b.id,!0,b.enc_op)},Jose.WebCryptographer.prototype.wrapCek=function(a,b){return crypto.subtle.wrapKey("raw",a,b,this.key_encryption.id)},Jose.WebCryptographer.prototype.unwrapCek=function(b,c){var d=a(this.content_encryption),e=this.content_encryption.specific_cek_bytes>0,f=this.key_encryption.id;return crypto.subtle.unwrapKey("raw",b,c,f,d.id,e,d.dec_op)};var a=function(a){var b=a.specific_cek_bytes;if(b){if(16==b)return{id:{name:"AES-CBC",length:128},enc_op:["encrypt"],dec_op:["decrypt"]};if(32==b)return{id:{name:"AES-CBC",length:256},enc_op:["encrypt"],dec_op:["decrypt"]};if(64==b)return{id:{name:"HMAC",hash:{name:"SHA-256"}},enc_op:["sign"],dec_op:["verify"]};if(128==b)return{id:{name:"HMAC",hash:{name:"SHA-384"}},enc_op:["sign"],dec_op:["verify"]};Jose.assert(!1,"getCekWorkaround: invalid len")}return{id:a.id,enc_op:["encrypt"],dec_op:["decrypt"]}};Jose.WebCryptographer.prototype.encrypt=function(a,c,e,f){var g=this.content_encryption;if(a.length!=g.iv_bytes)return Promise.reject(Error("invalid IV length"));if(g.auth.aead){var h=g.auth.tag_bytes,i={name:g.id.name,iv:a,additionalData:c,tagLength:8*h};return e.then(function(a){return crypto.subtle.encrypt(i,a,f).then(function(a){var b=a.byteLength-h;return{cipher:a.slice(0,b),tag:a.slice(b)}})})}var j=b(g,e,["encrypt"]),k=j[0],l=j[1],m=l.then(function(b){var c={name:g.id.name,iv:a};return crypto.subtle.encrypt(c,b,f)}),n=m.then(function(b){return d(g,k,c,a,b)});return Promise.all([m,n]).then(function(a){var b=a[0],c=a[1];return{cipher:b,tag:c}})},Jose.WebCryptographer.prototype.decrypt=function(a,c,e,f,h){var i=function(a,b,c,d){return Jose.assert(c instanceof Uint8Array,"compare: invalid input"),Jose.assert(d instanceof Uint8Array,"compare: invalid input"),b.then(function(b){var e=crypto.subtle.sign(a.auth.id,b,c),f=crypto.subtle.sign(a.auth.id,b,d);return Promise.all([e,f]).then(function(a){var b=new Uint8Array(a[0]),c=new Uint8Array(a[1]);if(b.length!=c.length)throw new Error("compare failed");for(var d=0;d<b.length;d++)if(b[d]!=c[d])throw new Error("compare failed");return Promise.accept(null)})})};if(e.length!=this.content_encryption.iv_bytes)return Promise.reject(Error("decryptCiphertext: invalid IV"));var j=this.content_encryption;if(j.auth.aead){var k={name:j.id.name,iv:e,additionalData:c,tagLength:8*j.auth.tag_bytes};return a.then(function(a){var b=g.arrayBufferConcat(f,h);return crypto.subtle.decrypt(k,a,b)})}var l=b(j,a,["decrypt"]),m=l[0],n=l[1],o=d(j,m,c,e,f);return Promise.all([n,o]).then(function(a){var b=a[0],c=a[1];return i(j,m,new Uint8Array(c),h).then(function(){var a={name:j.id.name,iv:e};return crypto.subtle.decrypt(a,b,f)})["catch"](function(){return Promise.reject(Error("decryptCiphertext: MAC failed."))})})},Jose.WebCryptographer.prototype.sign=function(a,b,c){var d=this.content_sign;return a.alg&&(d=e(a.alg)),c.then(function(c){return crypto.subtle.sign(d.id,c,g.arrayFromString(g.Base64Url.encode(JSON.stringify(a))+"."+g.Base64Url.encodeArray(b)))})["catch"](function(a){console.log(a)})},Jose.WebCryptographer.prototype.verify=function(a,b,c,d){var e=this.content_sign;return d.then(function(d){return crypto.subtle.verify(e.id,d,c,g.arrayFromString(a+"."+b))})};var b=function(a,b,c){var d=b.then(function(a){return crypto.subtle.exportKey("raw",a)}),e=d.then(function(b){if(8*b.byteLength!=a.id.length+8*a.auth.key_bytes)return Promise.reject(Error("encryptPlainText: incorrect cek length"));var c=b.slice(0,a.auth.key_bytes);return crypto.subtle.importKey("raw",c,a.auth.id,!1,["sign"])}),f=d.then(function(b){if(8*b.byteLength!=a.id.length+8*a.auth.key_bytes)return Promise.reject(Error("encryptPlainText: incorrect cek length"));var d=b.slice(a.auth.key_bytes);return crypto.subtle.importKey("raw",d,a.id,!1,c)});return[e,f]},c=function(a){switch(a){case"RSA-OAEP":return{jwe_name:"RSA-OAEP",id:{name:"RSA-OAEP",hash:{name:"SHA-1"}}};case"RSA-OAEP-256":return{jwe_name:"RSA-OAEP-256",id:{name:"RSA-OAEP",hash:{name:"SHA-256"}}};case"A128KW":return{jwe_name:"A128KW",id:{name:"AES-KW",length:128}};case"A256KW":return{jwe_name:"A256KW",id:{name:"AES-KW",length:256}};case"A128CBC-HS256":return{jwe_name:"A128CBC-HS256",id:{name:"AES-CBC",length:128},iv_bytes:16,specific_cek_bytes:32,auth:{key_bytes:16,id:{name:"HMAC",hash:{name:"SHA-256"}},truncated_bytes:16}};case"A256CBC-HS512":return{jwe_name:"A256CBC-HS512",id:{name:"AES-CBC",length:256},iv_bytes:16,specific_cek_bytes:64,auth:{key_bytes:32,id:{name:"HMAC",hash:{name:"SHA-512"}},truncated_bytes:32}};case"A128GCM":return{jwe_name:"A128GCM",id:{name:"AES-GCM",length:128},iv_bytes:12,auth:{aead:!0,tag_bytes:16}};case"A256GCM":return{jwe_name:"A256GCM",id:{name:"AES-GCM",length:256},iv_bytes:12,auth:{aead:!0,tag_bytes:16}};default:throw Error("unsupported algorithm: "+a)}},d=function(a,b,c,d,e){return b.then(function(b){var f=new Uint8Array(g.arrayFromInt32(8*c.length)),h=new Uint8Array(8);h.set(f,4);var i=g.arrayBufferConcat(c,d,e,h);return crypto.subtle.sign(a.auth.id,b,i).then(function(b){return b.slice(0,a.auth.truncated_bytes)})})},e=function(a){switch(a){case"RS256":return{jwa_name:"RS256",id:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}}};case"RS384":return{jwa_name:"RS384",id:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}}};case"RS512":return{jwa_name:"RS512",id:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}}};case"HS256":return{jwa_name:"HS256",id:{name:"HMAC",hash:{name:"SHA-256"}}};case"HS384":return{jwa_name:"HS384",id:{name:"HMAC",hash:{name:"SHA-384"}}};case"HS512":return{jwa_name:"HS512",id:{name:"HMAC",hash:{name:"SHA-512"}}};case"ES256":return{jwa_name:"ES256",id:{name:"ECDSA",hash:{name:"SHA-256"}}};case"ES384":return{jwa_name:"ES384",id:{name:"ECDSA",hash:{name:"SHA-384"}}};case"ES512":return{jwa_name:"ES512",id:{name:"ECDSA",hash:{name:"SHA-512"}}};default:throw Error("unsupported algorithm: "+a)}},f=function(a){switch(a){case"RS256":case"RS384":case"RS512":case"HS256":case"HS384":case"HS512":case"ES256":case"ES384":case"ES512":return{publicKey:"verify",privateKey:"sign"};case"RSA-OAEP":case"RSA-OAEP-256":case"A128KW":case"A256KW":return{publicKey:"wrapKey",privateKey:"unwrapKey"};default:throw Error("unsupported algorithm: "+a)}};JoseJWE.Utils={};var g={};JoseJWE.Utils.importRsaPublicKey=function(a,b){var d,h,i,j=null;if(b=b||"RSA-OAEP",i=f(b),"wrapKey"==i.publicKey)d=g.convertRsaKey(a,["n","e"]),j=c(b);else{h={};for(var k in a)a.hasOwnProperty(k)&&(h[k]=a[k]);j=e(b),!h.alg&&b&&(h.alg=b),d=g.convertRsaKey(h,["n","e"]),d.ext=!0}return crypto.subtle.importKey("jwk",d,j.id,!1,[i.publicKey])},JoseJWE.Utils.importRsaPrivateKey=function(a,b){var d,h,i,j;if(b=b||"RSA-OAEP",j=f(b),"unwrapKey"==j.privateKey)d=g.convertRsaKey(a,["n","e","d","p","q","dp","dq","qi"]),h=c("RSA-OAEP");else{i={};for(var k in a)a.hasOwnProperty(k)&&(i[k]=a[k]);h=e(b),!i.alg&&b&&(i.alg=b),d=g.convertRsaKey(i,["n","e","d","p","q","dp","dq","qi"]),d.ext=!0}return crypto.subtle.importKey("jwk",d,h.id,!1,[j.privateKey])},g.isString=function(a){return"string"==typeof a||a instanceof String},g.arrayish=function(a){return a instanceof Array?a:a instanceof Uint8Array?a:a instanceof ArrayBuffer?new Uint8Array(a):void Jose.assert(!1,"arrayish: invalid input")},g.convertRsaKey=function(a,b){var c={},d=[];b.map(function(b){void 0===a[b]&&d.push(b)}),d.length>0&&Jose.assert(!1,"convertRsaKey: Was expecting "+d.join()),void 0!==a.kty&&Jose.assert("RSA"==a.kty,"convertRsaKey: expecting rsa_key['kty'] to be 'RSA'"),c.kty="RSA",void 0!==a.alg?c.alg=a.alg:c.alg="RSA-OAEP";for(var e=function(a){return parseInt(a,16)},f=0;f<b.length;f++){var h=b[f],i=a[h];if("e"==h)"number"==typeof i&&(i=g.Base64Url.encodeArray(g.stripLeadingZeros(g.arrayFromInt32(i))));else if(/^([0-9a-fA-F]{2}:)+[0-9a-fA-F]{2}$/.test(i)){var j=i.split(":").map(e);i=g.Base64Url.encodeArray(g.stripLeadingZeros(j))}else"string"!=typeof i&&Jose.assert(!1,"convertRsaKey: expecting rsa_key['"+h+"'] to be a string");c[h]=i}return c},g.arrayFromString=function(a){Jose.assert(g.isString(a),"arrayFromString: invalid input");var b=a.split("").map(function(a){return a.charCodeAt(0)});return new Uint8Array(b)},g.stringFromArray=function(a){Jose.assert(a instanceof ArrayBuffer,"stringFromArray: invalid input"),a=new Uint8Array(a),r="";for(var b=0;b<a.length;b++)r+=String.fromCharCode(a[b]);return r},g.stripLeadingZeros=function(a){a instanceof ArrayBuffer&&(a=new Uint8Array(a));for(var b=!0,c=[],d=0;d<a.length;d++)b&&0===a[d]||(b=!1,c.push(a[d]));return c},g.arrayFromInt32=function(a){Jose.assert("number"==typeof a,"arrayFromInt32: invalid input"),Jose.assert(a==a|0,"arrayFromInt32: out of range");for(var b=new Uint8Array(new Uint32Array([a]).buffer),c=new Uint8Array(4),d=0;4>d;d++)c[d]=b[3-d];return c.buffer},g.arrayBufferConcat=function(){for(var a=[],b=0,c=0;c<arguments.length;c++)a.push(g.arrayish(arguments[c])),b+=a[c].length;var d=new Uint8Array(b),e=0;for(c=0;c<arguments.length;c++)for(var f=0;f<a[c].length;f++)d[e++]=a[c][f];return Jose.assert(e==b,"arrayBufferConcat: unexpected offset"),d},g.Base64Url={},g.Base64Url.encode=function(a){return Jose.assert(g.isString(a),"Base64Url.encode: invalid input"),btoa(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")},g.Base64Url.encodeArray=function(a){a=g.arrayish(a);var b="";for(i=0;i<a.length;i++)b+=String.fromCharCode(a[i]);return g.Base64Url.encode(b)},g.Base64Url.decode=function(a){return Jose.assert(g.isString(a),"Base64Url.decode: invalid input"),atob(a.replace(/-/g,"+").replace(/_/g,"/"))},g.Base64Url.decodeArray=function(a){return Jose.assert(g.isString(a),"Base64Url.decodeArray: invalid input"),g.arrayFromString(g.Base64Url.decode(a))},JoseJWE.Encrypter=function(a,b){this.cryptographer=a,this.key_promise=b,this.userHeaders={}},JoseJWE.Encrypter.prototype.addHeader=function(a,b){this.userHeaders[a]=b},JoseJWE.Encrypter.prototype.encrypt=function(a){var b=function(a,b){var c={};for(var d in this.userHeaders)c[d]=this.userHeaders[d];c.alg=this.cryptographer.getKeyEncryptionAlgorithm(),c.enc=this.cryptographer.getContentEncryptionAlgorithm();var e=g.Base64Url.encode(JSON.stringify(c)),f=this.cryptographer.createIV(),h=g.arrayFromString(e);return b=g.arrayFromString(b),this.cryptographer.encrypt(f,h,a,b).then(function(a){return a.header=e,a.iv=f,a})},c=this.cryptographer.createCek(),d=Promise.all([this.key_promise,c]).then(function(a){var b=a[0],c=a[1];return this.cryptographer.wrapCek(c,b)}.bind(this)),e=b.bind(this,c,a)();return Promise.all([d,e]).then(function(a){var b=a[0],c=a[1];return c.header+"."+g.Base64Url.encodeArray(b)+"."+g.Base64Url.encodeArray(c.iv)+"."+g.Base64Url.encodeArray(c.cipher)+"."+g.Base64Url.encodeArray(c.tag)})},JoseJWE.Decrypter=function(a,b){this.cryptographer=a,this.key_promise=b,this.headers={}},JoseJWE.Decrypter.prototype.getHeaders=function(){return this.headers},JoseJWE.Decrypter.prototype.decrypt=function(a){var b=a.split(".");if(5!=b.length)return Promise.reject(Error("decrypt: invalid input"));if(this.headers=JSON.parse(g.Base64Url.decode(b[0])),!this.headers.alg)return Promise.reject(Error("decrypt: missing alg"));if(!this.headers.enc)return Promise.reject(Error("decrypt: missing enc"));if(this.cryptographer.setKeyEncryptionAlgorithm(this.headers.alg),this.cryptographer.setContentEncryptionAlgorithm(this.headers.enc),this.headers.crit)return Promise.reject(Error("decrypt: crit is not supported"));var c=g.Base64Url.decodeArray(b[1]),d=this.key_promise.then(function(a){return this.cryptographer.unwrapCek(c,a)}.bind(this)),e=this.cryptographer.decrypt(d,g.arrayFromString(b[0]),g.Base64Url.decodeArray(b[2]),g.Base64Url.decodeArray(b[3]),g.Base64Url.decodeArray(b[4]));return e.then(g.stringFromArray)},JoseJWS.Signer=function(a,b){this.cryptographer=a,this.key_promise=JoseJWE.Utils.importRsaPrivateKey(b,a.getContentSignAlgorithm(),"sign"),this.headers={}},JoseJWS.Signer.prototype.getHeaders=function(){return this.headers},JoseJWS.Signer.prototype.sign=function(a,b,c){if(b||(b={}),b.alg||(b.alg=cryptographer.getContentSignAlgorithm(),b.typ="JWT"),g.isString(a))a=g.arrayFromString(a);else try{a=g.arrayish(a)}catch(d){a instanceof Object&&(a=g.arrayFromString(JSON.stringify(a)))}return this.cryptographer.sign(b,a,this.key_promise).then(function(d){return new h(b,c,a,d)})};var h=function(a,b,c,d){this.header=b,this.payload=g.Base64Url.encodeArray(c),this.signature=g.Base64Url.encodeArray(d),this["protected"]=g.Base64Url.encode(JSON.stringify(a))};h.prototype.JsonSerialize=function(){return JSON.stringify(this)},h.prototype.CompactSerialize=function(){return this["protected"]+"."+this.payload+"."+this.signature},JoseJWS.Verifier=function(a,b,c){var d,e,f,h,i,j,k,l=this,m=/^([a-z_\\-])\\.([a-z_\\-])\\.([a-z_\\-])$/i;if(l.cryptographer=a,d=a.getContentSignAlgorithm(),l.cryptographer=new Jose.WebCryptographer,g.isString(b)){if(e=m.exec(b)){if(4!=e.length)throw new Error("wrong JWS compact serialization format");b={"protected":e[1],payload:e[2],signature:e[3]}}}else if("object"!=typeof b)throw new Error("data format not supported");f=b["protected"],h=b.header,i=b.payload,j=b.signature,l.signature=g.arrayFromString(g.Base64Url.decode(j)),l.aad=f,k=g.Base64Url.decode(f);try{k=JSON.parse(k)}catch(n){}if(!k&&!h)throw new Error("at least one header is required");if(!k.alg)throw new Error("'alg' is a mandatory header");if(k.alg!=d)throw new Error("the alg header '"+k.alg+"' doesn't match the requested algorithm '"+d+"'");if(k&&k.typ&&"JWT"!=k.typ)throw new Error("typ '"+k.typ+"' not supported");l.payload=i,l.key_promise=JoseJWE.Utils.importRsaPublicKey(c,d,"verify")},JoseJWS.Verifier.prototype.verify=function(){var a=this;return a.cryptographer.verify(a.aad,a.payload,a.signature,a.key_promise)}}();